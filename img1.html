<html>
	<head>
		<script type="text/javascript">
			function brillo(){
				var img = new Image();
				var imgurl = '';
				imgurl = document.getElementById('urltxt').value;
				img.src = imgurl;
				var ctebrillo = document.getElementById('brillotxt').value;
				var canvas = document.getElementById('canvas');
				canvas.height = img.height;
				canvas.width = img.width;
				var ctx = canvas.getContext('2d');
				ctx.drawImage(img, 0, 0);
				var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				var data = imageData.data;
				var cte=parseInt(ctebrillo);
				for (var i = 0; i < data.length; i += 4) {
					data[i] = data[i]+cte; // red
					data[i + 1] = data[i + 1]+cte; // green
					data[i + 2] = data[i + 2]+cte; // blue
				}
				ctx.putImageData(imageData, 0, 0);
			}
			
			function rojo(){ filtraColor(1,0,0); }
			function verde(){ filtraColor(0,1,0); }
			function azul(){ filtraColor(0,0,1); }
			
			function filtraColor(r,g,b){
				var img = new Image();
				var imgurl = '';
				imgurl = document.getElementById('urltxt').value;
				img.src = imgurl;
				var canvas = document.getElementById('canvas');
				canvas.height = img.height;
				canvas.width = img.width;
				var ctx = canvas.getContext('2d');
				ctx.drawImage(img, 0, 0);
				var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				var data = imageData.data;
				for (var i = 0; i < data.length; i += 4) {
					if(r == 1){
						data[i] = data[i]; // red
					}else{
						data[i] = 0;
					}
					if(g==1){
						data[i + 1] = data[i + 1]; // green
					}else{
						data[i+1] = 0;
					}
					if(b==1){
						data[i + 2] = data[i + 2]; // blue
					}else{
						data[i+2] = 0;
					}
				}
				ctx.putImageData(imageData, 0, 0);
			}
			
			function grisRojo(){ grisRGB(1,0,0); }
			function grisVerde(){ grisRGB(0,1,0); }
			function grisAzul(){ grisRGB(0,0,1); }
			function grisRGB(r,g,b){
				var img = new Image();
				var imgurl = '';
				imgurl = document.getElementById('urltxt').value;
				img.src = imgurl;
				var canvas = document.getElementById('canvas');
				canvas.height = img.height;
				canvas.width = img.width;
				var ctx = canvas.getContext('2d');
				ctx.drawImage(img, 0, 0);
				var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				var data = imageData.data;
				var actual = 0;
				for (var i = 0; i < data.length; i += 4) {
					if(r == 1){ actual = data[i]; }
					if(g==1){ actual = data[i + 1]; }
					if(b==1){ actual = data[i+2]; }
					data[i] = actual;
					data[i + 1] = actual; // green
					data[i + 2] = actual; // blue
				}
				ctx.putImageData(imageData, 0, 0);
			}
			
			function grisPromedio(){
				var img = new Image();
				var imgurl = '';
				imgurl = document.getElementById('urltxt').value;
				img.src = imgurl;
				var canvas = document.getElementById('canvas');
				canvas.height = img.height;
				canvas.width = img.width;
				var ctx = canvas.getContext('2d');
				ctx.drawImage(img, 0, 0);
				var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				var data = imageData.data;
				var actual = 0;
				for (var i = 0; i < data.length; i += 4) {
					actual = (data[i] + data[i+1] + data[i+2]) / 3
					data[i] = actual;
					data[i + 1] = actual; // green
					data[i + 2] = actual; // blue
				}
				ctx.putImageData(imageData, 0, 0);
			}
			
			function grisEc(){
				var img = new Image();
				var imgurl = '';
				imgurl = document.getElementById('urltxt').value;
				img.src = imgurl;
				var canvas = document.getElementById('canvas');
				canvas.height = img.height;
				canvas.width = img.width;
				var ctx = canvas.getContext('2d');
				ctx.drawImage(img, 0, 0);
				var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				var data = imageData.data;
				var actual = 0;
				for (var i = 0; i < data.length; i += 4) {
					actual = (data[i]*0.3 + data[i+1]*0.59 + data[i+2]*0.11) / 3
					data[i] = actual;
					data[i + 1] = actual; // green
					data[i + 2] = actual; // blue
				}
				ctx.putImageData(imageData, 0, 0);
			}

			function mosaico(){
				var img = new Image();
				var imgurl = '';
				imgurl = document.getElementById('urltxt').value;
				img.src = imgurl;
				var canvas = document.getElementById('canvas');
				canvas.height = img.height;
				canvas.width = img.width;
				var ancho = img.width;
				alert('anchox');
				var ctx = canvas.getContext('2d');
				ctx.drawImage(img, 0, 0);
				var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				var data = imageData.data;
				var blockx = document.getElementById('mosaicoxtxt').value;
				var blocky = document.getElementById('mosaicoytxt').value;
				var blocksize = parseInt(blockx)*parseInt(blockx);
				var dlen = data.length / 4 ;
				var numbloques = dlen/blocksize;
				var pxrestantes = data.length % (blocksize*4);
				alert("el block size "+blocksize+"dlen "+data.length+" numbloq "+numbloques);
				var iant = 0;
				var nose = 0;
				actr = 0;
				actg = 0;
				actb = 0;
				var idxs = [];
				for(var it = 0 ; it<= numbloques;it+=1){
					for (var x = 0; x < blockx; x += 1) {
						for(var y=0; y<blockx; y+=1){
							//alert("x "+x+" y "+y);
							//0 1 10 11
							//2 3 12 13
							// pidx(0) => 0 , p(1)=> 4, p(2)=>8
							var pxid =(x * ancho + y) + nose*blockx;
							pxid*=4;
							//como cada pixel se encuentra en su indice * 4 entonces pxid*=4
							actr+=data[pxid];
							actg+=data[pxid+1];
							actb+=data[pxid+2];
							idxs.push(pxid);
							//alert("x "+x+" y "+y+" it "+it+" blockx "+blockx+" ancho "+ancho+" pxid "+pxid);
						}
					}
					actr = actr/(blockx*blockx);
					actg = actg/(blockx*blockx);
					actb = actb/(blockx*blockx);
					for(var idxar=0;idxar<idxs.length;idxar+=1){
						//alert(idxs[idxar]);
						data[idxs[idxar]] = actr;
						data[idxs[idxar]+1] = actg;
						data[idxs[idxar]+2] = actb;
					}
					idxs = [];
					actr = 0;
					actg = 0;
					actb = 0;
					nose+=1;
				}
				ctx.putImageData(imageData, 0, 0);
			}
		</script>
	</head>
	<body>
		<div>
			Url
			<input type="text" id="urltxt" name="urltxt" size=60><br>
			<br>Mosaico
			<input type="text" id="mosaicoxtxt" name="mosaicoxtxt" size=2>
			<input type="text" id="mosaicoytxt" name="mosaicoytxt" size=2>
			<input id="testbtn" value="Mosaico" type="button" onclick="mosaico();"/>
			Brillo: <input type="text" id="brillotxt" name="brillotxt" size=4>
			<input id="testbtn" value="" type="button" onclick="brillo();"/>
			<input id="testbtn" value="Rojo" type="button" onclick="rojo();"/>
			<input id="testbtn" value="Verde" type="button" onclick="verde();"/>
			<input id="testbtn" value="Azul" type="button" onclick="azul();"/>
			<input id="testbtn" value="GrisRojo" type="button" onclick="grisRojo();"/>
			<input id="testbtn" value="GrisVerde" type="button" onclick="grisVerde();"/>
			<input id="testbtn" value="GrisAzul" type="button" onclick="grisAzul();"/>
			<input id="testbtn" value="GrisPromedio" type="button" onclick="grisPromedio();"/>
			<input id="testbtn" value="GrisEcuacion" type="button" onclick="grisEc();"/>
			
		</div>
		<canvas id="canvas"></canvas>
	</body>
</html>

